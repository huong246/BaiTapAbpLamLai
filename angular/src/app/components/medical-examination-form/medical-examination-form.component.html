<!-- medical-examination-form.component.html -->

<div class="medical-form-container">
  <!-- Status Bar -->
  <div class="status-bar" [ngClass]="connectionStatus">
    <div class="status-indicator">
      <span class="dot"></span>
      <span class="text">SignalR: {{ connectionStatus }}</span>
    </div>

    <div class="processing-status" *ngIf="processingStatus">
      <span class="spinner"></span>
      <span>{{ processingStatus }}</span>
    </div>

    <button class="btn-test" (click)="testConnection()">Test Connection</button>
  </div>

  <!-- Main Form -->
  <form [formGroup]="medicalForm" (ngSubmit)="onSubmit()" class="medical-form">

    <!-- SECTION 1: Thông tin bệnh nhân + Sinh hiệu -->
    <div class="form-section">
      <h3>Thông tin bệnh nhân</h3>

      <div class="form-row three-columns">
        <div class="form-group">
          <label>Giới tính</label>
          <select formControlName="gender">
            <option value="Nam">Nam</option>
            <option value="Nữ">Nữ</option>
          </select>
        </div>

        <div class="form-group">
          <label>Năm sinh</label>
          <input type="number" formControlName="birthYear" placeholder="2001">
        </div>

        <div class="form-group">
          <label>Tuổi</label>
          <input type="text" formControlName="age" readonly>
        </div>
      </div>

      <h4>Sinh hiệu</h4>
      <div class="form-row three-columns">
        <div class="form-group" [class.updated]="isFieldUpdated('pulse')">
          <label>Mạch (nhịp/phút)</label>
          <input type="text" formControlName="pulse" placeholder="90">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('bloodPressure')">
          <label>Huyết áp (mmHg)</label>
          <input type="text" formControlName="bloodPressure" placeholder="120/80">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('temperature')">
          <label>Nhiệt độ (°C)</label>
          <input type="text" formControlName="temperature" placeholder="36.5">
        </div>
      </div>

      <div class="form-row three-columns">
        <div class="form-group" [class.updated]="isFieldUpdated('height')">
          <label>Chiều cao (cm)</label>
          <input type="text" formControlName="height" placeholder="170">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('weight')">
          <label>Cân nặng (kg)</label>
          <input type="text" formControlName="weight" placeholder="65">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('bmi')">
          <label>BMI</label>
          <input type="text" formControlName="bmi" readonly>
        </div>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('waistline')">
        <label>Vòng bụng (cm)</label>
        <input type="text" formControlName="waistline" placeholder="80">
      </div>
    </div>

    <!-- SECTION 2: Tiền sử -->
    <div class="form-section">
      <h3>Tiền sử</h3>

      <div class="form-group" [class.updated]="isFieldUpdated('familyHistory')">
        <label>Tiền sử gia đình</label>
        <textarea formControlName="familyHistory" rows="3"
                  placeholder="Nhập tiền sử gia đình..."></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('allergyHistory')">
        <label>Tiền sử dị ứng</label>
        <textarea formControlName="allergyHistory" rows="3"
                  placeholder="Nhập tiền sử dị ứng..."></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('medicalHistory')">
        <label>Bệnh sử</label>
        <textarea formControlName="medicalHistory" rows="4"
                  placeholder="Nhập bệnh sử..."></textarea>
      </div>
    </div>

    <!-- SECTION 3: Khám lâm sàng -->
    <div class="form-section">
      <h3>Khám lâm sàng</h3>

      <div class="form-group" [class.updated]="isFieldUpdated('bodyExamination')">
        <label>Toàn thân</label>
        <textarea formControlName="bodyExamination" rows="3"
                  placeholder="Khám toàn thân..."></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('partExamination')">
        <label>Bộ phận</label>
        <textarea formControlName="partExamination" rows="3"
                  placeholder="Khám bộ phận..."></textarea>
      </div>

      <div class="form-row two-columns">
        <div class="form-group" [class.updated]="isFieldUpdated('leftEyeDegree')">
          <label>Độ cận MT</label>
          <input type="text" formControlName="leftEyeDegree">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('rightEyeDegree')">
          <label>Độ cận MP</label>
          <input type="text" formControlName="rightEyeDegree">
        </div>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('fetalHeart')">
        <label>Tim thai</label>
        <input type="text" formControlName="fetalHeart">
      </div>
    </div>

    <!-- SECTION 4: ICD & Chẩn đoán -->
    <div class="form-section">
      <h3>ICD & Chẩn đoán</h3>

      <div class="form-row two-columns">
        <div class="form-group">
          <label>Mã bệnh chính ICD-10</label>
          <input type="text" formControlName="icdMain" placeholder="Nhập mã ICD-10">
        </div>

        <div class="form-group">
          <label>Mã bệnh phụ ICD-10</label>
          <input type="text" formControlName="icdSub" placeholder="Nhập mã ICD-10">
        </div>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('diseaseProgress')">
        <label>Diễn biến bệnh</label>
        <textarea formControlName="diseaseProgress" rows="3"></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('initialDiagnosis')">
        <label>Chẩn đoán ban đầu</label>
        <textarea formControlName="initialDiagnosis" rows="2"></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('finalDiagnosis')">
        <label>Chẩn đoán</label>
        <textarea formControlName="finalDiagnosis" rows="3"></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('treatment')">
        <label>Phương pháp điều trị</label>
        <textarea formControlName="treatment" rows="3"></textarea>
      </div>
    </div>

    <!-- SECTION 5: Hẹn khám -->
    <div class="form-section">
      <h3>Hẹn khám</h3>

      <div class="form-row three-columns">
        <div class="form-group">
          <label>Kết quả khám</label>
          <input type="text" formControlName="resultType">
        </div>

        <div class="form-group">
          <label>Loại hình khám</label>
          <input type="text" formControlName="visitType">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('revisitAfterDays')">
          <label>Khám lại sau (ngày)</label>
          <input type="text" formControlName="revisitAfterDays" placeholder="7">
        </div>
      </div>

      <div class="form-row two-columns">
        <div class="form-group" [class.updated]="isFieldUpdated('revisitDate')">
          <label>Ngày khám lại</label>
          <input type="date" formControlName="revisitDate">
        </div>

        <div class="form-group" [class.updated]="isFieldUpdated('revisitTime')">
          <label>Giờ khám lại</label>
          <input type="time" formControlName="revisitTime">
        </div>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('revisitNote')">
        <label>Nội dung hẹn khám</label>
        <textarea formControlName="revisitNote" rows="2"></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('note')">
        <label>Ghi chú</label>
        <textarea formControlName="note" rows="2"></textarea>
      </div>

      <div class="form-group" [class.updated]="isFieldUpdated('doctorNote')">
        <label>Lời dặn</label>
        <textarea formControlName="doctorNote" rows="2"></textarea>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="resetForm()">
        Làm mới
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="!medicalForm.valid">
        Lưu thông tin
      </button>
    </div>
  </form>
</div>
